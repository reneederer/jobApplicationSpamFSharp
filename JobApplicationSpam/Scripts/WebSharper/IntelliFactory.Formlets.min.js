(function(){"use strict";var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w;a=window;b=a.IntelliFactory=a.IntelliFactory||{};c=b.Formlets=b.Formlets||{};d=c.Base=c.Base||{};e=d.Tree=d.Tree||{};f=e.Tree=e.Tree||{};g=e.Edit=e.Edit||{};h=a.WebSharper;i=h&&h.Obj;j=d.D=d.D||{};k=d.LayoutUtils=d.LayoutUtils||{};l=d.Result=d.Result||{};m=d.Form=d.Form||{};n=d.Formlet=d.Formlet||{};o=d.FormletProvider=d.FormletProvider||{};p=d.FormletBuilder=d.FormletBuilder||{};q=d.Validator=d.Validator||{};r=b&&b.Runtime;s=h&&h.Seq;t=h&&h.Enumerator;u=h&&h.List;v=h&&h.Util;w=h&&h.Unchecked;f=e.Tree=r.Class({Map:function(x){return this.$==1?new f({$:1,$0:x(this.$0)}):this.$==2?new f({$:2,$0:this.$0.Map(x),$1:this.$1.Map(x)}):f.Empty;},get_Sequence:function(){return this.$==1?[this.$0]:this.$==2?s.append(this.$0.get_Sequence(),this.$1.get_Sequence()):[];},GetEnumerator:function(){return t.Get(this.get_Sequence());},GetEnumerator0:function(){return t.Get(this.get_Sequence());}},null,f);f.Empty=new f({$:0});g=e.Edit=r.Class({get_Sequence:function(){return this.$==1?this.$0.get_Sequence():this.$==2?this.$0.get_Sequence():this.$0.get_Sequence();},GetEnumerator:function(){return t.Get(this.get_Sequence());},GetEnumerator0:function(){return t.Get(this.get_Sequence());}},null,g);e.DeepFlipEdit=function(x){return x.$==1?new g({$:2,$0:e.DeepFlipEdit(x.$0)}):x.$==2?new g({$:1,$0:e.DeepFlipEdit(x.$0)}):new g({$:0,$0:x.$0});};e.FlipEdit=function(x){return x.$==1?new g({$:2,$0:x.$0}):x.$==2?new g({$:1,$0:x.$0}):new g({$:0,$0:x.$0});};e.Delete=function(){return new g({$:0,$0:f.Empty});};e.Transform=function(x,y){return y.$==1?new g({$:1,$0:e.Transform(x,y.$0)}):y.$==2?new g({$:2,$0:e.Transform(x,y.$0)}):new g({$:0,$0:x(y.$0)});};e.Set=function(x){return new g({$:0,$0:new f({$:1,$0:x})});};e.Apply=function(x,y){function z(A,B){return A.$==1?B.$==2?new f({$:2,$0:z(A.$0,B.$0),$1:B.$1}):z(new g({$:1,$0:A.$0}),new f({$:2,$0:f.Empty,$1:B})):A.$==2?B.$==2?new f({$:2,$0:B.$0,$1:z(A.$0,B.$1)}):z(new g({$:2,$0:A.$0}),new f({$:2,$0:B,$1:f.Empty})):A.$0;}return z(x,y);};e.ReplacedTree=function(x,y){var z,A,B,C,D,E;while(true)if(x.$==1){z=x.$0;if(y.$==2){A=y.$0;x=z;y=A;}else{B=y;x=new g({$:1,$0:z});y=new f({$:2,$0:f.Empty,$1:B});}}else if(x.$==2){C=x.$0;if(y.$==2){D=y.$1;x=C;y=D;}else{E=y;x=new g({$:2,$0:C});y=new f({$:2,$0:E,$1:f.Empty});}}else return y;};e.FromSequence=function(x){function y(z,A){return new f({$:2,$0:z,$1:new f({$:1,$0:A})});}return(((r.Curried3(s.fold))(y))(f.Empty))(x);};e.Range=function(x,y){var z,A,B,C,D,E,F,G,H;z=x;A=y;B=0;while(true)if(z.$==1){C=z.$0;if(A.$==2){D=A.$0;z=C;A=D;}else{z=C;A=f.Empty;}}else if(z.$==2){E=z.$0;if(A.$==2){F=A.$1;G=A.$0;z=E;A=F;B=B+e.Count(G);}else{H=A;z=E;A=f.Empty;B=B+e.Count(H);}}else return[B,e.Count(A)];};e.Count=function(x){var y,z,A,B,C,D,E,F,G;y=0;z=u.T.Empty;A=x;while(true)if(A.$==2){B=A.$1;C=A.$0;z=new u.T({$:1,$0:B,$1:z});A=C;}else{D=A;E=D.$==0?0:1;if(z.$==1){F=z.$1;G=z.$0;y=y+E;z=F;A=G;}else return y+E;}};e.ShowEdit=function(x){function y(z){return z.$==1?"Left > "+y(z.$0):z.$==2?"Right > "+y(z.$0):"Replace";}return y(x);};j=d.D=r.Class({Dispose:a.ignore},i,j);j.New=r.Ctor(function(){},j);k=d.LayoutUtils=r.Class({New:function(x){return{Apply:function(y){var z,A;z=x();A=[f.Empty];return{$:1,$0:[z.Body,y.Subscribe(v.observer(function(B){var C,D;C=e.ReplacedTree(B,A[0]);A[0]=e.Apply(B,A[0]);D=(e.Range(B,A[0]))[0];z.Remove(C.get_Sequence());s.iteri(function(E,F){return(z.Insert(D+E))(F);},B);}))]};}};},Delay:function(x){return{Apply:function(y){return x().Apply(y);}};},Default:function(){return{Apply:function(){return null;}};}},i,k);k.New=r.Ctor(function(x){},k);l.Sequence=function(x){return s.fold(function(y,z){return y.$==1?z.$==1?{$:1,$0:u.append(y.$0,z.$0)}:{$:1,$0:y.$0}:z.$==1?{$:1,$0:z.$0}:{$:0,$0:u.append(y.$0,u.ofArray([z.$0]))};},{$:0,$0:u.T.Empty},x);};l.Map=function(x,y){return y.$==1?{$:1,$0:y.$0}:{$:0,$0:x(y.$0)};};l.OfOption=function(x){return x==null?{$:1,$0:u.T.Empty}:{$:0,$0:x.$0};};l.Apply=function(x,y){return x.$==1?y.$==1?{$:1,$0:u.append(x.$0,y.$0)}:{$:1,$0:x.$0}:y.$==1?{$:1,$0:y.$0}:{$:0,$0:x.$0(y.$0)};};l.Join=function(x){return x.$==1?{$:1,$0:x.$0}:x.$0;};m=d.Form=r.Class({Dispose:function(){this.Dispose$1();}},null,m);m.New=function(x,y,z,A){return new m({Body:x,Dispose:y,Notify:z,State:A});};n=d.Formlet=r.Class({MapResultI:function(x){var y;y=this;return n.New(this.Layout,function(){var z;z=y.Build();y.Utils.Reactive.Select(z.State,x);return m.New(z.Body,z.Dispose$1,z.Notify,z.State);},this.Utils);},BuildI:function(){return this.Build();},LayoutI:function(){return this.Layout;}},null,n);n.New=function(x,y,z){return new n({Layout:x,Build:y,Utils:z});};o=d.FormletProvider=r.Class({BindWith:function(x,y,z){var A;A=this;return A.New(function(){var B,C,D,E;B=A.Bind(y,z).BuildI();return m.New((C=A.U.DefaultLayout.Apply(A.U.Reactive.Where(B.Body,function(F){return F.$==1&&true;})),(D=A.U.DefaultLayout.Apply(A.U.Reactive.Where(B.Body,function(F){return F.$==2&&true;})),C!=null&&C.$==1&&(D!=null&&D.$==1&&(E=[C.$0[0],D.$0[0]],true))?A.U.Reactive.Return(e.Set(x(E[0],E[1]))):A.U.Reactive.Never())),B.Dispose$1,B.Notify,B.State);});},WithNotification:function(x,y){var z,A;z=this;A=z.New(function(){var B;B=z.BuildForm(y);return m.New(B.Body,B.Dispose$1,function(C){B.Notify(C);x(C);},B.State);});return z.WithLayout(y.LayoutI(),A);},LiftResult:function(x){return this.MapResult(function(y){return{$:0,$0:y};},x);},Sequence:function(x){var y,z,A;y=u.ofSeq(x);return y.$==1?(z=this.Return(function(B){return function(C){return new u.T({$:1,$0:B,$1:C});};}),(A=this.Sequence(y.$1),this.Apply(this.Apply(z,y.$0),A))):this.Return(u.T.Empty);},Delay:function(x){var y;y=this;return n.New(this.L.Delay(function(){return x().LayoutI();}),function(){return y.BuildForm(x());},this.U);},Bind:function(x,y){var z;z=this;return z.Join(z.Map(y,x));},WithCancelation:function(x,y){var z,A,B;function C(D,E){return E.$==0?{$:0,$0:null}:D.$==1?{$:1,$0:D.$0}:{$:0,$0:{$:1,$0:D.$0}};}z=this.Return(function(D){return function(E){return C(D,E);};});A=this.LiftResult(x);B=this.LiftResult(y);return this.MapResult(l.Join,this.Apply(this.Apply(z,A),B));},Deletable:function(x){var y;y=this;return this.Replace(x,function(z){return z!=null&&z.$==1?y.Return({$:1,$0:z.$0}):y.ReturnEmpty(null);});},Replace:function(x,y){var z;z=this;return z.Switch(z.Map(y,x));},WithNotificationChannel:function(x){var y,z;y=this;z=y.New(function(){var A;function B(C){return[C,A.Notify];}A=x.BuildI();return m.New(A.Body,A.Dispose$1,A.Notify,y.U.Reactive.Select(A.State,function(C){return l.Map(B,C);}));});return y.WithLayout(x.LayoutI(),z);},SelectMany:function(x){var y;y=this;return y.New(function(){var z,A,B;function C(){var D;function E(F){return new g({$:2,$0:F});}B[0]=(D=B[0],function(F){return E(D(F));});}z=y.BuildForm(x);A=y.U.Reactive.Heat(y.U.Reactive.Choose(z.State,function(D){return D.$==1?null:{$:1,$0:y.BuildForm(D.$0)};}));return m.New(y.U.Reactive.Merge(y.U.Reactive.Select(z.Body,function(D){return new g({$:1,$0:D});}),(B=[function(D){return new g({$:1,$0:D});}],y.U.Reactive.SelectMany(y.U.Reactive.Select(A,function(D){C();return y.U.Reactive.Select(D.Body,B[0]);})))),function(){z.Dispose$1();},function(D){z.Notify(D);},y.U.Reactive.Select(y.U.Reactive.CollectLatest(y.U.Reactive.Select(A,function(D){return D.State;})),l.Sequence));});},FlipBody:function(x){var y,z;y=this;z=y.New(function(){var A;A=x.BuildI();return m.New(y.U.Reactive.Select(A.Body,e.FlipEdit),A.Dispose$1,A.Notify,A.State);});return y.WithLayout(x.LayoutI(),z);},Switch:function(x){var y;y=this;return y.New(function(){var z,A;z=y.BuildForm(y.ApplyLayout(y.WithLayoutOrDefault(x)));A=y.U.Reactive.Heat(y.U.Reactive.Choose(z.State,function(B){return B.$==1?null:{$:1,$0:y.BuildForm(B.$0)};}));return m.New(y.U.Reactive.Concat(z.Body,y.U.Reactive.Switch(y.U.Reactive.Select(A,function(B){return B.Body;}))),function(){z.Dispose$1();},function(B){z.Notify(B);},y.U.Reactive.Switch(y.U.Reactive.Select(A,function(B){return B.State;})));});},Join:function(x){var y;y=this;return y.New(function(){var z,A,B;z=y.BuildForm(x);A=y.U.Reactive.Heat(y.U.Reactive.Select(z.State,function(C){return C.$==1?y.Fail(C.$0):y.BuildForm(C.$0);}));return m.New((B=y.U.Reactive.Select(y.U.Reactive.Switch(y.U.Reactive.Select(A,function(C){return y.U.Reactive.Concat(y.U.Reactive.Return(e.Delete()),C.Body);})),function(C){return new g({$:2,$0:C});}),y.U.Reactive.Merge(y.U.Reactive.Select(z.Body,function(C){return new g({$:1,$0:C});}),B)),function(){z.Dispose$1();},function(C){z.Notify(C);},y.U.Reactive.Switch(y.U.Reactive.Select(A,function(C){return C.State;})));});},EmptyForm:function(){return m.New(this.U.Reactive.Never(),a.ignore,a.ignore,this.U.Reactive.Never());},Empty:function(){var x;x=this;return x.New(function(){return m.New(x.U.Reactive.Return(e.Delete()),a.ignore,a.ignore,x.U.Reactive.Never());});},Never:function(){var x;x=this;return x.New(function(){return m.New(x.U.Reactive.Never(),a.ignore,a.ignore,x.U.Reactive.Never());});},ReturnEmpty:function(x){var y;y=this;return y.New(function(){return m.New(y.U.Reactive.Return(e.Delete()),a.ignore,a.ignore,y.U.Reactive.Return({$:0,$0:x}));});},FailWith:function(x){var y;y=this;return y.New(function(){return y.Fail(x);});},Fail:function(x){return m.New(this.U.Reactive.Never(),a.ignore,a.ignore,this.U.Reactive.Return({$:1,$0:x}));},Return:function(x){var y;y=this;return y.New(function(){return m.New(y.U.Reactive.Never(),a.ignore,a.ignore,y.U.Reactive.Return({$:0,$0:x}));});},Apply:function(x,y){var z;z=this;return z.New(function(){var A,B;function C(D,E){return l.Apply(E,D);}A=z.BuildForm(x);B=z.BuildForm(y);return m.New(z.U.Reactive.Merge(z.U.Reactive.Select(A.Body,function(D){return new g({$:1,$0:D});}),z.U.Reactive.Select(B.Body,function(D){return new g({$:2,$0:D});})),function(){B.Dispose$1();A.Dispose$1();},function(D){B.Notify(D);A.Notify(D);},z.U.Reactive.CombineLatest(B.State,A.State,function(D){return function(E){return C(D,E);};}));});},Map:function(x,y){return this.MapResult(function(z){return l.Map(x,z);},y);},MapResult:function(x,y){var z;z=this;return n.New(y.LayoutI(),function(){var A;A=y.BuildI();return m.New(A.Body,A.Dispose$1,A.Notify,z.U.Reactive.Select(A.State,x));},this.U);},WithLayoutOrDefault:function(x){return this.MapBody(a.id,x);},MapBody:function(x,y){var z;z=this;return this.WithLayout({Apply:function(A){var B,C;B=y.LayoutI().Apply(A);return B==null?(C=z.U.DefaultLayout.Apply(A),C==null?null:{$:1,$0:[x(C.$0[0]),C.$0[1]]}):{$:1,$0:[x(B.$0[0]),B.$0[1]]};}},y);},AppendLayout:function(x,y){return this.WithLayout(x,this.ApplyLayout(y));},ApplyLayout:function(x){var y;y=this;return y.New(function(){var z,A;z=x.BuildI();return m.New((A=x.LayoutI().Apply(z.Body),A==null?z.Body:y.U.Reactive.Return(e.Set(A.$0[0]))),z.Dispose$1,z.Notify,z.State);});},InitWithFailure:function(x){var y,z;y=this;z=y.New(function(){var A;A=x.BuildI();return m.New(A.Body,A.Dispose$1,A.Notify,y.U.Reactive.Concat(y.U.Reactive.Return({$:1,$0:u.T.Empty}),A.State));});return y.WithLayout(x.LayoutI(),z);},ReplaceFirstWithFailure:function(x){var y,z;y=this;z=y.New(function(){var A,B;A=x.BuildI();return m.New(A.Body,A.Dispose$1,A.Notify,(B=y.U.Reactive.Drop(A.State,1),y.U.Reactive.Concat(y.U.Reactive.Return({$:1,$0:u.T.Empty}),B)));});return y.WithLayout(x.LayoutI(),z);},InitWith:function(x,y){var z,A;z=this;A=z.New(function(){var B;B=y.BuildI();return m.New(B.Body,B.Dispose$1,B.Notify,z.U.Reactive.Concat(z.U.Reactive.Return({$:0,$0:x}),B.State));});return z.WithLayout(y.LayoutI(),A);},WithLayout:function(x,y){return n.New(x,function(){return y.BuildI();},this.U);},FromState:function(x){var y;y=this;return y.New(function(){return m.New(y.U.Reactive.Never(),a.ignore,a.ignore,x);});},New:function(x){return n.New(this.L.Default(),x,this.U);},BuildForm:function(x){var y,z,A;y=x.BuildI();z=x.LayoutI().Apply(y.Body);return z!=null&&z.$==1?(A=z.$0[1],m.New(this.U.Reactive.Return(e.Set(z.$0[0])),function(){y.Dispose$1();A.Dispose();},y.Notify,y.State)):y;}},i,o);o.New=r.Ctor(function(x){this.U=x;this.L=new k.New({Reactive:this.U.Reactive});},o);p=d.FormletBuilder=r.Class({ReturnFrom:a.id,Delay:function(x){return this.F.Delay(x);},Bind:function(x,y){return this.F.Bind(x,y);},Return:function(x){return this.F.Return(x);}},i,p);p.New=r.Ctor(function(x){this.F=x;},p);q=d.Validator=r.Class({IsNotEqual:function(x,y,z){return this.Validate(function(A){return!w.Equals(A,x);},y,z);},IsEqual:function(x,y,z){return this.Validate(function(A){return w.Equals(A,x);},y,z);},IsLessThan:function(x,y,z){return this.Validate(function(A){return w.Compare(A,x)===-1;},y,z);},IsGreaterThan:function(x,y,z){return this.Validate(function(A){return w.Compare(A,x)===1;},y,z);},IsTrue:function(x,y){return this.Validate(a.id,x,y);},IsFloat:function(x){var y;y=this;return function(z){return y.IsRegexMatch("^\\s*(\\+|-)?((\\d+(\\.\\d+)?)|(\\.\\d+))\\s*$",x,z);};},IsInt:function(x){var y;y=this;return function(z){return y.IsRegexMatch("^-?\\d+$",x,z);};},IsEmail:function(x){var y;y=this;return function(z){return y.IsRegexMatch("^[A-Za-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\\.[A-Za-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[A-Za-z0-9](?:[A-Za-z0-9-]*[A-Za-z0-9])?\\.)+[A-Za-z0-9](?:[A-Za-z0-9-]*[A-Za-z0-9])?$",x,z);};},IsRegexMatch:function(x,y,z){var A;A=this;return this.Validate(function(B){return A.VP.Matches(x,B);},y,z);},IsNotEmpty:function(x,y){return this.Validate(function(z){return z!=="";},x,y);},Is:function(x,y,z){return this.Validate(x,y,z);},Validate:function(x,y,z){return z.MapResultI(function(A){var B;return A.$==1?{$:1,$0:A.$0}:(B=A.$0,x(B)?{$:0,$0:B}:{$:1,$0:u.ofArray([y])});});}},i,q);q.New=r.Ctor(function(x){this.VP=x;},q);}());
